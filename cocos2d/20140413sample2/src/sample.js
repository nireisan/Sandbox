// Generated by CoffeeScript 1.6.3
(function() {
  var Sample, SampleScene;

  Sample = cc.Layer.extend({
    init: function() {
      var enemy, enemyFontSize, i, size, _i;
      this._super();
      size = cc.Director.getInstance().getWinSize();
      this.ship = cc.Sprite.create(s_ship);
      this.ship.setPosition(cc.p(size.width / 2, size.height / 2));
      this.ship.size = 30;
      this.addChild(this.ship, 5);
      this.enemies = [];
      for (i = _i = 0; _i <= 14; i = ++_i) {
        enemyFontSize = parseInt(Math.random() * 50 + 10);
        enemy = cc.LabelTTF.create("●", "Arial", enemyFontSize);
        enemy.v = cc.p(-5, (Math.random() - 0.5) * 3);
        enemy.size = enemyFontSize - 10;
        enemy.setColor(cc.c3b(255, 0, 0));
        enemy.setPosition(cc.p((Math.random() + 1) * size.width, Math.random() * size.height));
        this.scoreLabel = cc.LabelTTF.create("", "Arial", 17);
        this.scoreLabel.setPosition(cc.p(20, size.height - 20));
        this.scoreLabel.setAnchorPoint(cc.p(0, 1));
        this.addChild(this.scoreLabel, 10);
        this.addChild(enemy, 10);
        this.enemies.push(enemy);
      }
      this.scheduleUpdate();
      this.setTouchEnabled(true);
      return true;
    },
    update: function(dt) {
      var distance, enemy, k, pos, shipPos, size, _i, _len, _ref, _results;
      size = cc.Director.getInstance().getWinSize();
      shipPos = this.ship.getPosition();
      if (this.touched) {
        k = 0.7;
        this.ship.setPosition(shipPos.x, (shipPos.y * k) + (this.touched.y * (1.0 - k)));
      }
      _ref = this.enemies;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        enemy = _ref[_i];
        pos = enemy.getPosition();
        pos = cc.p(pos.x, pos.y);
        pos.x += enemy.v.x * (g.score + 10000) / 10000;
        pos.y += enemy.v.y;
        if (pos.x < 0) {
          pos.x = size.width;
        }
        if (pos.y < 0) {
          pos.y = size.height;
        }
        if (pos.y > size.height) {
          pos.y = 0;
        }
        distance = cc.pDistance(shipPos, pos);
        if (distance < this.ship.size / 2 + enemy.size / 2) {
          this.shakeView();
          if (!this.gameover) {
            cc.log('hit');
            cc.log(this.ship.size / 2 + enemy.size / 2);
            cc.log(distance);
            this.gameover = true;
            this.onGameover();
          }
        }
        enemy.setPosition(pos);
        _results.push(this.scoreLabel.setString("SCORE: " + g.score++));
      }
      return _results;
    },
    shakeView: function() {
      return this.setPosition(cc.p(Math.random() * 20, Math.random() * 10));
    },
    onGameover: function() {
      var transition;
      transition = cc.TransitionFade.create(1.0, new ResultScene());
      console.log("replaceScene");
      cc.Director.getInstance().replaceScene(transition);
    },
    onTouchesBegan: function(touches, event) {
      this.touched = touches[0].getLocation();
    },
    onTouchesMoved: function(touches, event) {
      this.touched = touches[0].getLocation();
    },
    onTouchesEnded: function(touches, event) {
      this.touched = null;
    },
    onTouchesCancelled: function(touches, event) {
      this.touched = null;
    }
  });

  SampleScene = cc.Scene.extend({
    onEnter: function() {
      var layer;
      this._super();
      layer = new Sample();
      layer.init();
      return this.addChild(layer);
    }
  });

  this.SampleScene = SampleScene;

}).call(this);
